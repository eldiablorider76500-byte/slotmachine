<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Machine à sous TikTok</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d3350 0, #050811 55%, #02030a 100%);
      color: #fff;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .machine-wrapper {
      width: 90vw;
      max-width: 1100px;
      height: 90vh;
      max-height: 650px;
      border-radius: 40px;
      padding: 20px 24px 28px;
      background: linear-gradient(180deg, #2c0f33 0%, #120615 50%, #20183b 100%);
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.8), 0 0 80px rgba(147, 51, 234, 0.6);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .machine-header {
      text-align: center;
      margin-bottom: 10px;
    }

    .machine-title {
      font-size: 32px;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 800;
      color: #ffd54f;
      text-shadow: 0 0 12px rgba(255, 215, 0, 0.9), 0 0 24px rgba(255, 64, 129, 0.7);
    }

    .machine-subtitle {
      margin-top: 4px;
      font-size: 13px;
      color: #e1e1ff;
      opacity: 0.85;
    }

    .top-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0 12px;
      font-size: 13px;
      color: #e5e5ff;
    }

    .player-info span {
      font-weight: 600;
      color: #ffeb3b;
    }

    .spin-counter {
      font-size: 12px;
      color: #b0a5ff;
    }

    .machine-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .reels-container {
      flex: 1;
      border-radius: 26px;
      padding: 18px 14px;
      background: radial-gradient(circle at top, #3147a0, #0b1023 55%, #040612 100%);
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .reels-frame {
      width: 100%;
      max-width: 820px;
      height: 100%;
      max-height: 320px;
      border-radius: 22px;
      padding: 16px;
      background: linear-gradient(180deg, #ff00b8, #ff9100);
      box-shadow: 0 0 28px rgba(255, 64, 129, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reels-inner {
      flex: 1;
      height: 100%;
      background: radial-gradient(circle at top, #121b33, #050814 70%);
      border-radius: 18px;
      border: 4px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      padding: 10px 14px;
      gap: 10px;
    }

    .reel {
      flex: 1;
      max-width: 150px;
      height: 100%;
      border-radius: 16px;
      background: linear-gradient(180deg, #171f33, #050713);
      box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .reel img {
      width: 80%;
      max-height: 90%;
      object-fit: contain;
      filter: drop-shadow(0 0 12px rgba(0, 0, 0, 0.9));
      transition: transform 0.08s linear;
    }

    .reel.spinning img {
      animation: wiggle 0.1s linear infinite;
      opacity: 0.9;
    }

    @keyframes wiggle {
      0% { transform: translateY(-4px); }
      50% { transform: translateY(4px); }
      100% { transform: translateY(-4px); }
    }

    .win-banner {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 16px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }

    .win-banner span {
      font-weight: 700;
    }

    .win-banner.big span { color: #ffeb3b; }
    .win-banner.mega span { color: #00e5ff; }
    .win-banner.giga span { color: #ff1744; }

    .machine-footer {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-top: 6px;
    }

    .control-panel {
      flex: 2;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 18px;
      padding: 10px 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
      font-size: 13px;
    }

    .control-panel label {
      font-size: 12px;
      color: #ddd;
    }

    .control-panel input {
      background: rgba(7, 10, 26, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 13px;
      outline: none;
      min-width: 110px;
    }

    .control-panel input:focus {
      border-color: #ff80ff;
      box-shadow: 0 0 0 1px rgba(255, 128, 255, 0.4);
    }

    .buttons-panel {
      flex: 1;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-primary {
      background: radial-gradient(circle at top, #00e676, #00b0ff);
      color: #011017;
      box-shadow: 0 0 14px rgba(0, 230, 118, 0.6);
    }

    .btn-secondary {
      background: radial-gradient(circle at top, #ffea00, #ff6f00);
      color: #120300;
      box-shadow: 0 0 14px rgba(255, 193, 7, 0.6);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.35);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0px) scale(0.98);
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
    }

    .helper-text {
      font-size: 11px;
      color: #b9b9ff;
      margin-top: 2px;
    }

    @media (max-width: 900px) {
      .machine-wrapper {
        padding: 16px;
      }
      .machine-title {
        font-size: 26px;
      }
      .reels-frame {
        padding: 10px;
      }
      .reel img {
        width: 90%;
      }
      .machine-footer {
        flex-direction: column;
        align-items: stretch;
      }
      .buttons-panel {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
<div class="machine-wrapper">
  <div class="machine-header">
    <div class="machine-title">Slot 3B TikTok</div>
    <div class="machine-subtitle">
      4 mêmes cadeaux sur la ligne = gain • Loup = <strong>GIGA WIN</strong> • Moto = <strong>MEGA WIN</strong>
    </div>
  </div>

  <div class="top-status">
    <div class="player-info">
      Joueur : <span id="playerNameDisplay">-</span> • Cadeau : <span id="giftCoinsDisplay">0</span> pièces • Tours restants : <span id="spinsLeftDisplay">0</span>
    </div>
    <div class="spin-counter">
      Tours joués : <span id="totalSpinsDisplay">0</span> • Tours depuis gros gain : <span id="sinceBigDisplay">0</span>
    </div>
  </div>

  <div class="machine-body">
    <div class="reels-container">
      <div id="winBanner" class="win-banner" style="display:none;">
        <span id="winTypeLabel"></span> — <span id="winSymbolLabel"></span>
      </div>

      <div class="reels-frame">
        <div class="reels-inner">
          <div class="reel" data-index="0"><img src="" alt="reel 1"></div>
          <div class="reel" data-index="1"><img src="" alt="reel 2"></div>
          <div class="reel" data-index="2"><img src="" alt="reel 3"></div>
          <div class="reel" data-index="3"><img src="" alt="reel 4"></div>
        </div>
      </div>
    </div>

    <div class="machine-footer">
      <div class="control-panel">
        <div>
          <label for="playerName">Pseudo TikTok :</label><br>
          <input id="playerName" type="text" placeholder="Pseudo…" />
        </div>
        <div>
          <label for="giftCoins">Valeur du cadeau (pièces) :</label><br>
          <input id="giftCoins" type="number" min="1" placeholder="ex: 99" />
        </div>
        <div class="helper-text">
          Minimum <strong>49 pièces</strong> pour jouer.<br>
          49–98 → 1 tour • 99–298 → 3 tours • 299–2998 → 7 tours • 2999+ → 70 tours. <br>
          Les gros cadeaux (loup, moto) ne peuvent tomber qu'après <strong>200 tours</strong> minimum.
        </div>
      </div>

      <div class="buttons-panel">
        <button id="setGiftBtn" class="btn btn-secondary">Valider le cadeau</button>
        <button id="spinBtn" class="btn btn-primary" disabled>SPIN</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ----- CONFIG DES SYMBOLS (cadeaux) -----
  const IMAGE_BASE_PATH = "Cadeaux/";

  const SYMBOLS = [
    { id: "cygne",        file: "IMG-20251120-WA0017.jpg", label: "Cygne royal",       isBig: false },
    { id: "loup",         file: "IMG-20251120-WA0018.jpg", label: "Loup",              isBig: true,  bigType: "giga" },
    { id: "rosejamais",   file: "IMG-20251120-WA0019.jpg", label: "Rose à jamais",     isBig: false },
    { id: "casquette",    file: "IMG-20251120-WA0020.jpg", label: "Casquette",         isBig: false },
    { id: "manette",      file: "IMG-20251120-WA0021.jpg", label: "Manette de jeu",    isBig: false },
    { id: "confetti",     file: "IMG-20251120-WA0022.jpg", label: "Confetti",          isBig: false },
    { id: "amourlangage", file: "IMG-20251120-WA0023.jpg", label: "Amour en langage",  isBig: false },
    { id: "donuts",       file: "IMG-20251120-WA0024.jpg", label: "Donut",             isBig: false },
    { id: "glace",        file: "IMG-20251120-WA0025.jpg", label: "Cornet glacé",      isBig: false },
    { id: "parfum",       file: "IMG-20251120-WA0026.jpg", label: "Parfum",            isBig: false },
    { id: "corgi",        file: "IMG-20251120-WA0027.jpg", label: "Corgi",             isBig: false },
    { id: "gants",        file: "IMG-20251120-WA0028.jpg", label: "Gants de boxe",     isBig: false },
    { id: "rosa",         file: "IMG-20251120-WA0029.jpg", label: "Rosa",              isBig: false },
    { id: "gg",           file: "IMG-20251120-WA0030.jpg", label: "GG",                isBig: false },
    { id: "positivite",   file: "IMG-20251120-WA0031.jpg", label: "De la positivité",  isBig: false },
    { id: "tofu",         file: "IMG-20251120-WA0032.jpg", label: "Tofu",              isBig: false },
    { id: "coeurdoigts",  file: "IMG-20251120-WA0033.jpg", label: "Cœur avec les doigts", isBig: false },
    { id: "coeurnuage",   file: "IMG-20251120-WA0034.jpg", label: "Cœur nuage",        isBig: false },
    { id: "moto",         file: "IMG-20251120-WA0035.jpg", label: "Moto",             isBig: true,  bigType: "mega" },
    { id: "pistolet",     file: "IMG-20251120-WA0042.jpg", label: "Pistolet à argent", isBig: false }
  ];

  const NON_BIG_SYMBOLS = SYMBOLS.filter(s => !s.isBig);

  // ----- ÉTAT GLOBAL -----
  let currentPlayerName = "";
  let currentGiftCoins = 0;
  let spinsLeft = 0;

  let isSpinning = false;
  let totalSpins = 0;
  let spinsSinceBigPrize = 0;

  const reels = Array.from(document.querySelectorAll(".reel"));
  const winBanner = document.getElementById("winBanner");
  const winTypeLabel = document.getElementById("winTypeLabel");
  const winSymbolLabel = document.getElementById("winSymbolLabel");

  const playerNameDisplay = document.getElementById("playerNameDisplay");
  const giftCoinsDisplay = document.getElementById("giftCoinsDisplay");
  const spinsLeftDisplay = document.getElementById("spinsLeftDisplay");
  const totalSpinsDisplay = document.getElementById("totalSpinsDisplay");
  const sinceBigDisplay = document.getElementById("sinceBigDisplay");

  const setGiftBtn = document.getElementById("setGiftBtn");
  const spinBtn = document.getElementById("spinBtn");

  // ----- UTILS -----
  function randomSymbol() {
    const index = Math.floor(Math.random() * SYMBOLS.length);
    return SYMBOLS[index];
  }

  function randomNonBigSymbol() {
    const index = Math.floor(Math.random() * NON_BIG_SYMBOLS.length);
    return NON_BIG_SYMBOLS[index];
  }

  function calcSpinsFromCoins(coins) {
    if (coins >= 2999) return 70;
    if (coins >= 299)  return 7;
    if (coins >= 99)   return 3;
    if (coins >= 49)   return 1;
    return 0;
  }

  function updateStatusDisplays() {
    playerNameDisplay.textContent = currentPlayerName || "-";
    giftCoinsDisplay.textContent = currentGiftCoins.toString();
    spinsLeftDisplay.textContent = spinsLeft.toString();
    totalSpinsDisplay.textContent = totalSpins.toString();
    sinceBigDisplay.textContent = spinsSinceBigPrize.toString();
  }

  function showWinBanner(type, symbol) {
    let cls = "";
    let label = "";
    if (type === "giga") {
      cls = "giga";
      label = "GIGA WIN !!!";
    } else if (type === "mega") {
      cls = "mega";
      label = "MEGA WIN !!";
    } else if (type === "big") {
      cls = "big";
      label = "BIG WIN !";
    } else {
      winBanner.style.display = "none";
      return;
    }

    winBanner.classList.remove("big", "mega", "giga");
    winBanner.classList.add(cls);
    winTypeLabel.textContent = label;
    winSymbolLabel.textContent = symbol.label;
    winBanner.style.display = "flex";
  }

  function hideWinBanner() {
    winBanner.style.display = "none";
  }

  // ----- INITIALISATION DES REELS -----
  function initReels() {
    reels.forEach(reel => {
      const img = reel.querySelector("img");
      const sym = randomSymbol();
      img.src = IMAGE_BASE_PATH + sym.file;
      img.alt = sym.label;
      reel.dataset.symbolId = sym.id;
    });
  }

  initReels();
  updateStatusDisplays();

  // ----- LOGIQUE DU CADEAU -----
  setGiftBtn.addEventListener("click", () => {
    const nameInput = document.getElementById("playerName");
    const coinsInput = document.getElementById("giftCoins");

    const name = nameInput.value.trim();
    const coins = parseInt(coinsInput.value, 10);

    if (!name) {
      alert("Merci d'entrer le pseudo TikTok du joueur.");
      return;
    }

    if (isNaN(coins) || coins <= 0) {
      alert("Merci d'entrer le nombre de pièces du cadeau.");
      return;
    }

    const spins = calcSpinsFromCoins(coins);
    if (spins === 0) {
      alert("Minimum 49 pièces pour jouer.");
      return;
    }

    currentPlayerName = name;
    currentGiftCoins = coins;
    spinsLeft += spins; // on ajoute au stock de tours (au cas où la personne envoie plusieurs cadeaux).
    updateStatusDisplays();

    spinBtn.disabled = false;
  });

  // ----- LOGIQUE DES SPINS -----
  spinBtn.addEventListener("click", () => {
    if (isSpinning) return;
    if (spinsLeft <= 0) {
      alert("Plus de tours pour ce joueur. Il faut un nouveau cadeau (min 49 pièces).");
      spinBtn.disabled = true;
      return;
    }

    // Consommer un tour
    spinsLeft -= 1;
    totalSpins += 1;
    spinsSinceBigPrize += 1;
    updateStatusDisplays();

    startSpin();
  });

  function startSpin() {
    isSpinning = true;
    hideWinBanner();

    // Durées légèrement décalées pour chaque rouleau (fin vers ~3 secondes)
    const reelDurations = [1600, 2000, 2400, 2800]; // en ms

    const finalSymbols = new Array(4);
    let reelsStopped = 0;

    reels.forEach((reel, index) => {
      reel.classList.add("spinning");
      const img = reel.querySelector("img");

      // petite animation de shuffle
      const shuffleInterval = setInterval(() => {
        const sym = randomSymbol();
        img.src = IMAGE_BASE_PATH + sym.file;
        img.alt = sym.label;
      }, 80);

      setTimeout(() => {
        clearInterval(shuffleInterval);

        // symbole final tiré au hasard
        let finalSym = randomSymbol();
        finalSymbols[index] = finalSym;

        img.src = IMAGE_BASE_PATH + finalSym.file;
        img.alt = finalSym.label;
        reel.dataset.symbolId = finalSym.id;
        reel.classList.remove("spinning");

        reelsStopped += 1;

        if (reelsStopped === reels.length) {
          // Tous les rouleaux sont arrêtés -> appliquer la règle des gros gains
          applyBigPrizeRulesAndComputeWin(finalSymbols);
          isSpinning = false;
          updateStatusDisplays();

          // Si plus de tours, désactiver le bouton
          if (spinsLeft <= 0) {
            spinBtn.disabled = true;
          }
        }
      }, reelDurations[index]);
    });
  }

  function applyBigPrizeRulesAndComputeWin(finalSymbols) {
    // Vérifier si 4 mêmes symboles
    const allSame = finalSymbols.every(s => s.id === finalSymbols[0].id);
    if (!allSame) {
      hideWinBanner();
      return;
    }

    let winningSymbol = finalSymbols[0];

    // Gestion du minimum 200 tours entre deux gros gains (loups / moto)
    if (winningSymbol.isBig) {
      if (spinsSinceBigPrize < 200) {
        // Pas encore 200 tours depuis un gros gain → on downgrade en symbole normal
        const replacement = randomNonBigSymbol();
        winningSymbol = replacement;
        for (let i = 0; i < reels.length; i++) {
          const img = reels[i].querySelector("img");
          img.src = IMAGE_BASE_PATH + replacement.file;
          img.alt = replacement.label;
          reels[i].dataset.symbolId = replacement.id;
          finalSymbols[i] = replacement;
        }
        // Dans ce cas, ce sera un Big Win simple
        showWinBanner("big", winningSymbol);
        return;
      } else {
        // Gros gain autorisé
        spinsSinceBigPrize = 0;
      }
    }

    // Déterminer le type de gain
    if (winningSymbol.id === "loup") {
      showWinBanner("giga", winningSymbol);
    } else if (winningSymbol.id === "moto") {
      showWinBanner("mega", winningSymbol);
    } else {
      showWinBanner("big", winningSymbol);
    }
  }
</script>
</body>
</html>
